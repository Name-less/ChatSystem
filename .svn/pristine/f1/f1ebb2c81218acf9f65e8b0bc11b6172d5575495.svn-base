package netWork;

import java.io.UnsupportedEncodingException;
import java.net.DatagramPacket;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Stack;

import org.json.JSONException;
import org.json.JSONObject;

import controller.Controller;

public class NetWorkInterface {
	
	private ArrayList<User> userList;
	private Controller controller;
	private UDPSender udpSender;
	private UDPReceiver udpReceiver;
	
	public static int portSender = 2222;
	public static int portReceiver = 1111;
	
	public static String myName = "Xineohp";

	public NetWorkInterface(Controller controller){
		this.userList = new ArrayList<User>();
		this.controller = controller;
		udpReceiver = new UDPReceiver(this);
		udpSender = new UDPSender();
		
		Thread runUDPThreadRec = new Thread(new runReceiver());
		runUDPThreadRec.start();
		
		Thread runUDPThreadSender = new Thread(new runSender());
		runUDPThreadSender.start();
	}
	
	public void addPacketRecu(DatagramPacket packet){
		Thread threadTraitePacket = new Thread(new TraiterPacketRecu(packet));
		threadTraitePacket.start();
	}
		
	/*
	 * 
	 * ACTION SUR CONTROLLER
	 * 
	 */
	
	public void addUserToList(String name, InetAddress ip,int port){
		User userToAdd = new User(name,ip,port);
		if(!this.exist(userToAdd)){
			this.userList.add(userToAdd);//peut être vérifier qu'il n'existe pas déja
			controller.majUserList(this.userList);
		}
	}
	
	public void removeUserToList(String name){
		if(this.userList.remove(name)){
			controller.majUserList(this.userList);
		}
	}
	
	public void addMessage(String from, String message,int numero){
		controller.afficheMessage(from, message, numero);
	}
	
	/*
	 * 
	 * LES RUNNABLES DE MES THREADS
	 * 
	 */
	
	public class runReceiver implements Runnable{

		@Override
		public void run() {
			// TODO Auto-generated method stub
			udpReceiver.run();
		}
		
	}
	
	public class runSender implements Runnable{

		@Override
		public void run() {
			// TODO Auto-generated method stub
			udpSender.run();
		}
		
	}
	
	public class TraiterPacketRecu implements Runnable{

		DatagramPacket toTreat;
		public TraiterPacketRecu(DatagramPacket packet){
			this.toTreat = packet;
		}
		
		@Override
		public void run() {
			// TODO Auto-generated method stub
			try {
				traiterPacketRecu(toTreat);
			} catch (UnsupportedEncodingException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			} catch (UnknownHostException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			} catch (JSONException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
		
	}
	
	/*
	 * 
	 * ACTIONS DECLANCHEE PAR LE CONTROLEUR
	 * 
	 */
	
	public void sendMessage(DatagramPacket packetToSend){
		udpSender.setDatagramPacket(packetToSend);
		synchronized(udpSender){
			udpSender.notify();
		}
	}
	
	/*
	 * 
	 * AUTRE METHODES
	 * 
	 */
	
	public boolean exist(User b){
		for(int i = 0;i<this.userList.size();i++){
			if(userList.get(i).compareTo(b)){
				return true;
			}
		}
		return false;
	}
	
	public String getNameFromIp(InetAddress address){
		for(int i = 0;i<this.userList.size();i++){
			if(userList.get(i).getIp().equals(address)){
				return userList.get(i).getName();
			}
		}
		return null;
	}

	public InetAddress getIpFromName(String name){
		for(int i = 0;i<this.userList.size();i++){
			if(userList.get(i).getName().equals(name)){
				return userList.get(i).getIp();
			}
		}
		return null;
	}
	
	
	public void traiterPacketRecu(DatagramPacket packetToTreat)throws UnsupportedEncodingException, JSONException, UnknownHostException{
		//on traite et on envoit au controller ce qu'il faut modifier
			JSONObject data;
			String test = new String(packetToTreat.getData(),"UTF-8");
			data = new JSONObject(test);
			if(data.getString(Controller.type).equals(Controller.message)){
				
				String message = data.getString(Controller.messageData);				
				addMessage(this.getNameFromIp(packetToTreat.getAddress()),message,0);
				
			}else if(data.getString(Controller.type).equals(Controller.messageAck)){
				
				//a traiter dans le futur ma gueule
				
			}else if(data.getString(Controller.type).equals(Controller.connect)){
				addUserToList(data.getString(Controller.userName),packetToTreat.getAddress(),packetToTreat.getPort());
				this.sendMessage(this.createMessage(Controller.connectAck,myName,packetToTreat.getAddress(),0,NetWorkInterface.portReceiver));

			}else if(data.getString(Controller.type).equals(Controller.disconnect)){
				
				removeUserToList(data.getString(Controller.userName));
				
			}else if(data.getString(Controller.type).equals(Controller.connectAck)){
				addUserToList(data.getString(Controller.userName),packetToTreat.getAddress(),packetToTreat.getPort());
				
			}			
	}
	
	public DatagramPacket createMessage(String type,String value,InetAddress host,int messageNumber,int port) throws UnknownHostException, JSONException, UnsupportedEncodingException {
		byte [] lol = new byte[1024];
		DatagramPacket message = new DatagramPacket(lol,0,host,port);
		
		JSONObject data = new JSONObject();
			if(type.equals(Controller.message)){
				
				data.put(Controller.type, Controller.message);
				data.put(Controller.messageData,value);
				message.setPort(port);
				message.setAddress(InetAddress.getLocalHost());
			
			}else if(type.equals(Controller.messageAck)){
				
				data.put(Controller.type, Controller.messageAck);
				data.put(Controller.messageData,messageNumber);
				message.setAddress(host);
				
			}else if(type.equals(Controller.connect)){
				
					data.put(Controller.type, Controller.connect);
					data.put(Controller.userName,value);
					message.setAddress(InetAddress.getLocalHost());
					message.setPort(port);

			}else if(type.equals(Controller.disconnect)){
				
					data.put(Controller.type, Controller.disconnect);
					message.setAddress(InetAddress.getByName("255.255.255.255"));
					
			}else if(type.equals(Controller.connectAck)){
				
				data.put(Controller.type, Controller.connectAck);
				data.put(Controller.userName, NetWorkInterface.myName);
				message.setAddress(host);
				
			}	
		
			System.out.println("type envoyé "+type +" data "+data.toString());
			message.setData(data.toString().getBytes("UTF-8"));
		
		return message;
	}
	
	
	
	
	
	
	
	
}
